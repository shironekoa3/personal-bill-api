import{m as ae,j as N,x as O,y as ne,r as se,i as p,o as x,e as C,s as n,a as u,g as o,q as c,d as l,z as ie,E as M,A as k,_ as re,B as de,k as me,C as ue,c as V,D as pe,t as b,G as ce,F as $,v as Y,H as fe,b as W,p as _e,h as he}from"./index-a7376f8a.js";import{g as ge,i as ye,c as xe,l as be,d as De,a as ve}from"./bill-da518fce.js";import{u as we,l as Ye}from"./category-9ad7b7f6.js";let S=new Date;S.setDate(1);S.setHours(0,0,0,0);let q=new Date;q.setHours(23,59,59);const Ie=ae("bill",()=>{let D=N({searchDate:[S,q],rawData:[],tableFilterData:[],filterText:""});const r=O(()=>{let y=0;return D.tableFilterData.forEach(v=>{y+=Number(v.expenditure)}),y.toFixed(2)}),_=O(()=>{let y=0;return D.tableFilterData.forEach(v=>{y+=Number(v.income)}),y.toFixed(2)}),t=O(()=>{let y=0;return D.tableFilterData.forEach(v=>{y+=v.detail.length}),y});return{state:D,allExpenditure:r,allIncome:_,allBillCount:t}}),ke=u("div",{class:"el-upload__text"},[c(" 拖入文件或 "),u("em",null,"选择文件")],-1),Ve=u("div",{class:"el-upload__tip"}," 只能上传 10MB 内的 xls/xlsx/csv 文件！ ",-1),Me={class:"dialog-footer"},He={__name:"HomeBillUpload",setup(D){let r=ne("state"),_=N({isLoading:!1,fileList:[]});const t=se(null),y=w=>{M.confirm("确定取消上传吗？","Warning",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{w()}).catch(()=>{})},v=()=>{_.fileList.length!==1?M.alert("请先选择文件！","提示：",{type:"info",confirmButtonText:"好的"}):t.value.submit()},H=w=>{w.code!==200?M.alert(w.msg,"错误！",{type:"error",confirmButtonText:"我知道了",callback:()=>{_.fileList=[]}}):M.confirm(`成功解析 ${w.data.length} 条账单<br/>是否导入？（取消会丢弃数据）`,"解析完成",{dangerouslyUseHTMLString:!0,confirmButtonText:"确定导入",cancelButtonText:"取消导入",type:"info"}).then(()=>{let h=`key=${w.data.key}`;ye(h).then(I=>{I.code===200&&M.alert(I.msg,"成功！",{type:"success",confirmButtonText:"好的",callback:()=>{r.showUpload=!1}}),_.fileList=[]})}).catch(()=>{let h=`key=${w.data.key}`;xe(h).then(I=>{I.code!==200&&k.error(I.msg)}),_.fileList=[]})},L=()=>{M.alert("上传失败！","错误！",{type:"error",confirmButtonText:"我知道了"})};return(w,h)=>{const I=p("el-icon"),F=p("el-upload"),T=p("el-button"),a=p("el-dialog");return x(),C(a,{modelValue:l(r).showUpload,"onUpdate:modelValue":h[2]||(h[2]=e=>l(r).showUpload=e),title:"上传账单",width:"550px","before-close":y},{footer:n(()=>[u("span",Me,[o(T,{onClick:h[1]||(h[1]=e=>l(r).showUpload=!1)},{default:n(()=>[c("取消")]),_:1}),o(T,{type:"primary",onClick:v},{default:n(()=>[c(" 解析 ")]),_:1})])]),default:n(()=>[o(F,{class:"upload-demo","file-list":l(_).fileList,"onUpdate:fileList":h[0]||(h[0]=e=>l(_).fileList=e),drag:"",action:l(ge)(),"on-success":H,"on-error":L,accept:".xlsx, .xls, .csv",limit:1,"auto-upload":!1,ref_key:"uploadRef",ref:t},{tip:n(()=>[Ve]),default:n(()=>[o(I,{class:"el-icon--upload"},{default:n(()=>[o(l(ie))]),_:1}),ke]),_:1},8,["file-list","action"])]),_:1},8,["modelValue"])}}};const A=D=>(_e("data-v-11c00f6a"),D=D(),he(),D),Be={class:"container"},Ce=A(()=>u("div",{class:"head"},[u("p",null,[c("账单列表"),u("span",null,"Bill List")])],-1)),Te={class:"body"},Ee={class:"opt"},Ue=A(()=>u("span",{style:{"margin-left":"4px"}},null,-1)),Le={class:"data"},Fe={key:0,class:"summary"},Pe={style:{color:"#f56c6c","margin-right":"20px"}},Oe={style:{color:"#67c23a","margin-right":"20px"}},$e={style:{color:"#409eff"}},Ne={class:"dialog-footer"},Se=A(()=>u("div",{id:"popover-dock"},null,-1)),Ae={class:"bill-item"},Ke={key:0,style:{color:"red"}},Re={key:1,style:{color:"green"}},ze={class:"bill-opt"},We={class:"bill-item"},qe={class:"bill-item"},Ge={class:"bill-item"},Je={__name:"HomeBillList",setup(D){const r=Ie(),_=we();let t=N({isLoading:!1,dialogVisible:!1,showUpload:!1,summary:{allExpenditure:0,allIncome:0,allBillCount:0},optionItem:{id:0,type:0,method:"微信",amount:0,date:"2023-10-22 16:00:00",categoryId:1,description:""},showPopover:!1,currentPopover:{id:0,amount:0,category:{id:0,name:"正在加载...",description:"正在加载...",createTime:"",updateTime:"",idDeleted:!1},categoryId:1,date:"2023-01-01 00:00:00",description:"正在加载...",method:"微信",orderId:'"100004990123102300069315368435599223"',type:0,createTime:"",updateTime:"",idDeleted:!1}});de("state",t);const y=[{text:"本月",value:()=>{let a=Y(new Date),e=a.startOf("month").format("YYYY-MM-DD HH:mm:ss"),s=a.endOf("month").format("YYYY-MM-DD HH:mm:ss");return[e,s]}},{text:"上个月",value:()=>{let a=Y(new Date).subtract(1,"month"),e=a.startOf("month").format("YYYY-MM-DD HH:mm:ss"),s=a.endOf("month").format("YYYY-MM-DD HH:mm:ss");return[e,s]}},{text:"上上个月",value:()=>{let a=Y(new Date).subtract(2,"month"),e=a.startOf("month").format("YYYY-MM-DD HH:mm:ss"),s=a.endOf("month").format("YYYY-MM-DD HH:mm:ss");return[e,s]}},{text:"近7天",value:()=>{let a=Y(new Date),e=a.subtract(6,"day").startOf("day").format("YYYY-MM-DD HH:mm:ss"),s=a.endOf("day").format("YYYY-MM-DD HH:mm:ss");return[e,s]}},{text:"近30天",value:()=>{let a=Y(new Date),e=a.subtract(29,"day").startOf("day").format("YYYY-MM-DD HH:mm:ss"),s=a.endOf("day").format("YYYY-MM-DD HH:mm:ss");return[e,s]}},{text:"近90天",value:()=>{let a=Y(new Date),e=a.subtract(89,"day").startOf("day").format("YYYY-MM-DD HH:mm:ss"),s=a.endOf("day").format("YYYY-MM-DD HH:mm:ss");return[e,s]}}],v=()=>{t.showPopover=!1,r.state.tableFilterData=[];let a=[];r.state.rawData.forEach(e=>{let s=Object.assign({},e);s.detail=s.detail.filter(d=>r.state.filterText.trim()==="支出"?d.type===0:r.state.filterText.trim()==="收入"?d.type===1:d.method.indexOf(r.state.filterText)!=-1||d.category.name.indexOf(r.state.filterText)!=-1||(d.amount+"").indexOf(r.state.filterText)!=-1||d.description.indexOf(r.state.filterText)!=-1),s.expenditure=0,s.income=0,s.detail.forEach(d=>{d.type===0?(s.expenditure+=d.amount,s.expenditure.toFixed(2)):s.income+=d.amount}),a.push(s)}),a=a.sort((e,s)=>new Date(s.date)-new Date(e.date)),a.forEach(e=>{e.expenditure=e.expenditure.toFixed(2),e.income=e.income.toFixed(2),e.detail=e.detail.sort((s,d)=>new Date(s.date)-new Date(d.date))}),t.summary.allExpenditure=0,t.summary.allIncome=0,t.summary.allBillCount=0,a.forEach(e=>{t.summary.allExpenditure+=Number(e.expenditure),t.summary.allIncome+=Number(e.income),t.summary.allBillCount+=Number(e.detail.length)}),r.state.tableFilterData=a},H=()=>{t.isLoading=!0;let a=[Y(r.state.searchDate[0]).format("YYYY-MM-DD HH:mm:ss"),Y(r.state.searchDate[1]).format("YYYY-MM-DD HH:mm:ss")];be(a).then(e=>{if(e.code!==200)k.error(e.msg);else{r.state.rawData=[];let s=new Map,d=[];e.data.forEach(m=>{let f=Y(m.date).format("YYYY-MM-DD");s.has(f)||(s.set(f,d.length),d.push({date:f,expenditure:0,income:0,detail:[]})),d[s.get(f)].detail.push(m),m.type===0?d[s.get(f)].expenditure+=m.amount:d[s.get(f)].income+=m.amount}),d=d.sort((m,f)=>new Date(f.date)-new Date(m.date)),d.forEach(m=>{m.expenditure=m.expenditure.toFixed(2),m.income=m.income.toFixed(2),m.detail=m.detail.sort((f,E)=>new Date(f.date)-new Date(E.date))}),r.state.rawData=d,r.state.tableFilterData=d,t.isLoading=!1}})},L=a=>{M.confirm("确定要删除吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{De(a.id).then(e=>{e.code===200?k.success("操作成功！"):k.error(e.msg)})}).catch(()=>{})},w=()=>{t.optionItem.amount=parseFloat(t.optionItem.amount).toFixed(2),t.optionItem.date=Y(t.optionItem.date).format("YYYY-MM-DD HH:mm:ss"),t.optionItem.method===""?k.warning("请输入支付方式！"):ve(t.optionItem).then(a=>{a.code===200?k.success("操作成功！"):k.error(a.msg),t.dialogVisible=!1,H()}).catch(a=>{console.log(a),k.error(a.msg),t.dialogVisible=!1,H()})},h=a=>{t.optionItem=a,a||(t.optionItem={id:0,type:0,method:"微信",amount:0,date:new Date,categoryId:1,description:""}),t.showPopover=!1,t.dialogVisible=!0,_.state.categories.length===1&&_.state.categories[0].name==="正在加载..."&&Ye().then(e=>{e.code!==200?k.error(e.msg):_.state.categories=e.data})};function I(a){var d,m;let e=null;(((d=a.target)==null?void 0:d.id)+"").indexOf("tag-")!=-1?e=a.target:(((m=a.target.parentNode)==null?void 0:m.id)+"").indexOf("tag-")!=-1&&(e=a.target.parentNode);let s=document.getElementById("popover-dock");e&&(e.appendChild(s),s.style.left=s.getClientRects().clientWidth/2+"px",t.showPopover=!1,setTimeout(()=>{t.showPopover=!0,setTimeout(()=>{t.showPopover=null},1)},1))}function F(){}function T(){let a=document.getElementById("popover-dock");document.body.appendChild(a)}return me(()=>{document.addEventListener("click",I),r.state.filterText="",H()}),(a,e)=>{const s=p("Plus"),d=p("el-icon"),m=p("el-button"),f=p("el-form-item"),E=p("el-date-picker"),G=p("Search"),J=p("Expand"),P=p("el-input"),Q=p("Filter"),K=p("el-form"),U=p("el-table-column"),R=p("el-tag"),X=p("el-table"),B=p("el-radio-button"),z=p("el-radio-group"),Z=p("el-option"),j=p("el-select"),ee=p("el-dialog"),te=p("el-popover"),oe=ue("loading");return x(),V($,null,[u("div",Be,[Ce,u("div",Te,[u("div",Ee,[o(K,{inline:!0,class:"demo-form-inline"},{default:n(()=>[o(f,{label:""},{default:n(()=>[o(m,{type:"primary",onClick:e[0]||(e[0]=i=>h(null))},{default:n(()=>[o(d,{class:"el-icon--left"},{default:n(()=>[o(s)]),_:1}),c(" 录入账单 ")]),_:1})]),_:1}),o(f,{label:""},{default:n(()=>[o(E,{modelValue:l(r).state.searchDate,"onUpdate:modelValue":e[1]||(e[1]=i=>l(r).state.searchDate=i),type:"daterange","unlink-panels":"","range-separator":"~","start-placeholder":"开始日期","end-placeholder":"结束日期",shortcuts:y,style:{width:"260px","margin-right":"4px"}},null,8,["modelValue"]),o(m,{type:"primary",onClick:H},{default:n(()=>[o(d,{class:"el-icon--left"},{default:n(()=>[o(G)]),_:1}),c(" 查询账单 ")]),_:1})]),_:1}),o(f,{label:""},{default:n(()=>[o(m,{type:"success",onClick:e[2]||(e[2]=i=>l(t).showUpload=!0)},{default:n(()=>[o(d,{class:"el-icon--left"},{default:n(()=>[o(J)]),_:1}),c(" 导入账单 ")]),_:1})]),_:1}),o(f,{label:""},{default:n(()=>[o(P,{modelValue:l(r).state.filterText,"onUpdate:modelValue":e[3]||(e[3]=i=>l(r).state.filterText=i),onKeydown:fe(v,["enter","native"]),placeholder:"支付方式/分类/描述/金额",style:{width:"200px"}},null,8,["modelValue","onKeydown"]),Ue,o(m,{type:"primary",onClick:v},{default:n(()=>[o(d,{class:"el-icon--left"},{default:n(()=>[o(Q)]),_:1}),c(" 筛选账单 ")]),_:1})]),_:1})]),_:1})]),u("div",Le,[pe((x(),C(X,{data:l(r).state.tableFilterData,height:"100%",style:{width:"100%"},stripe:""},{default:n(()=>[o(U,{prop:"date",label:"日期",sortable:"",width:"120"}),o(U,{prop:"expenditure",label:"支出",sortable:"","sort-method":(i,g)=>Number(i.expenditure)-Number(g.expenditure),width:"80"},null,8,["sort-method"]),o(U,{prop:"income",label:"收入",sortable:"","sort-method":(i,g)=>Number(i.income)-Number(g.income),width:"80"},null,8,["sort-method"]),o(U,{prop:"detail",label:"详细"},{default:n(i=>[(x(!0),V($,null,W(i.row.detail,g=>(x(),V("div",{key:g.id,style:{"user-select":"none",float:"left","margin-right":"5px",cursor:"pointer",position:"relative"}},[g.categoryId!==1?(x(),C(R,{key:0,type:g.type===0?"danger":"success",onClick:le=>l(t).currentPopover=g,id:`tag-${g.id}`,"disable-transitions":""},{default:n(()=>[c(" ¥"+b(g.amount),1)]),_:2},1032,["type","onClick","id"])):(x(),C(R,{key:1,type:"info",onClick:le=>l(t).currentPopover=g,id:`tag-${g.id}`,"disable-transitions":""},{default:n(()=>[c(" ¥"+b(g.amount),1)]),_:2},1032,["type","onClick","id"]))]))),128))]),_:1})]),_:1},8,["data"])),[[oe,l(t).isLoading]]),l(r).state.rawData.length>0?(x(),V("div",Fe,[c(" 总支出："),u("span",Pe,b(l(r).allExpenditure),1),c(" 总收入："),u("span",Oe,b(l(r).allIncome),1),c(" 订单数量："),u("span",$e,b(l(r).allBillCount),1)])):ce("",!0)])])]),o(He,{showUpload:l(t).showUpload},null,8,["showUpload"]),o(ee,{modelValue:l(t).dialogVisible,"onUpdate:modelValue":e[12]||(e[12]=i=>l(t).dialogVisible=i),title:l(t).optionItem.id===0?"录入账单":"更新账单",width:"500",style:{padding:"0 20px"}},{footer:n(()=>[u("span",Ne,[o(m,{size:"large",onClick:e[11]||(e[11]=i=>l(t).dialogVisible=!1)},{default:n(()=>[c("取消")]),_:1}),o(m,{type:"primary",size:"large",onClick:w},{default:n(()=>[c(b(l(t).optionItem.id===0?"录入":"更新"),1)]),_:1})])]),default:n(()=>[o(K,{"label-position":"right","label-width":"auto",style:{"max-width":"460px"}},{default:n(()=>[o(f,{label:"账单类型："},{default:n(()=>[o(z,{modelValue:l(t).optionItem.type,"onUpdate:modelValue":e[4]||(e[4]=i=>l(t).optionItem.type=i)},{default:n(()=>[o(B,{label:0},{default:n(()=>[c("支出")]),_:1}),o(B,{label:1},{default:n(()=>[c("收入")]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(f,{label:"支付方式："},{default:n(()=>[o(z,{modelValue:l(t).optionItem.method,"onUpdate:modelValue":e[5]||(e[5]=i=>l(t).optionItem.method=i)},{default:n(()=>[o(B,{label:"支付宝"}),o(B,{label:"微信"}),o(B,{label:"现金"})]),_:1},8,["modelValue"])]),_:1}),o(f,{label:"账单金额："},{default:n(()=>[o(P,{modelValue:l(t).optionItem.amount,"onUpdate:modelValue":e[6]||(e[6]=i=>l(t).optionItem.amount=i),type:"text",placeholder:"输入账单金额",onInput:e[7]||(e[7]=i=>l(t).optionItem.amount=i.replace(/[^\d.]/g,""))},null,8,["modelValue"])]),_:1}),o(f,{label:"账单时间："},{default:n(()=>[o(E,{modelValue:l(t).optionItem.date,"onUpdate:modelValue":e[8]||(e[8]=i=>l(t).optionItem.date=i),type:"datetime",placeholder:"选择日期时间"},null,8,["modelValue"])]),_:1}),o(f,{label:"账单分类："},{default:n(()=>[o(j,{modelValue:l(t).optionItem.categoryId,"onUpdate:modelValue":e[9]||(e[9]=i=>l(t).optionItem.categoryId=i),placeholder:"选择账单分类"},{default:n(()=>[(x(!0),V($,null,W(l(_).state.categories,i=>(x(),C(Z,{key:i.id,label:i.name,value:i.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(f,{label:"账单描述："},{default:n(()=>[o(P,{modelValue:l(t).optionItem.description,"onUpdate:modelValue":e[10]||(e[10]=i=>l(t).optionItem.description=i),type:"textarea",placeholder:"输入账单描述",rows:"5"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue","title"]),o(te,{placement:"top",class:"popover",visible:l(t).showPopover,width:340,trigger:"click",onBeforeEnter:F,onAfterLeave:T,"hide-after":0},{reference:n(()=>[Se]),default:n(()=>[u("div",Ae,[c(" 账单金额: "),l(t).currentPopover.type===0?(x(),V("span",Ke,"支出 ¥"+b(l(t).currentPopover.amount),1)):(x(),V("span",Re,"收入 ¥"+b(l(t).currentPopover.amount),1)),u("div",ze,[o(m,{type:"primary",link:"",onClick:e[13]||(e[13]=i=>h(l(t).currentPopover))},{default:n(()=>[c("编辑")]),_:1}),o(m,{type:"danger",link:"",onClick:e[14]||(e[14]=i=>L(l(t).currentPopover))},{default:n(()=>[c("删除")]),_:1})])]),u("div",We,[c(" 账单时间: "),u("span",null,b(l(t).currentPopover.date),1)]),u("div",qe,[c(" 账单分类: "),u("span",null,b(l(t).currentPopover.category.name),1)]),u("div",Ge,[c(" 账单备注: "),u("span",null,b(l(t).currentPopover.description),1)])]),_:1},8,["visible"])],64)}}},je=re(Je,[["__scopeId","data-v-11c00f6a"]]);export{je as default};
